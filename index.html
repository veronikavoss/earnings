<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>기업 실적 검색기</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .overflow-x-auto {
            -webkit-overflow-scrolling: touch;
        }
        #autocomplete-list::-webkit-scrollbar {
            width: 6px;
        }
        #autocomplete-list::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }
        #autocomplete-list::-webkit-scrollbar-track {
            background-color: #f1f5f9;
        }
        /* 슬라이더 스타일 커스텀 */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
            margin-top: -4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 4px;
        }
        /* 계산기 인풋 화살표 제거 */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans py-6 px-4 sm:px-6 lg:px-8">
    <div class="bg-white p-6 md:p-12 rounded-lg shadow-xl w-full max-w-5xl mx-auto my-4">
        <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-4 md:mb-6">기업 실적 검색기</h1>
        <p class="text-center text-gray-600 mb-6 md:mb-8 text-sm md:text-base">미국 상장 기업의 티커(Ticker)를 입력하세요 (예: AAPL, MSFT, IBM)</p>
        
        <!-- 검색 폼 -->
        <div class="flex flex-col sm:flex-row gap-3 mb-6 md:mb-8 relative">
            <div class="relative flex-grow">
                <input type="text" id="tickerInput" placeholder="티커 또는 회사명 입력 (예: AAPL, Apple)" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow text-lg" 
                       autocomplete="off" autocapitalize="characters">
                <ul id="autocomplete-list" class="hidden absolute z-50 w-full bg-white border border-gray-200 rounded-lg shadow-lg mt-1 max-h-60 overflow-y-auto text-left"></ul>
            </div>
            <button id="searchButton" class="w-full sm:w-auto bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors text-lg shadow-sm active:bg-blue-800">
                검색
            </button>
        </div>

        <!-- 로딩 및 결과 표시 영역 -->
        <div id="resultsArea">
            <div id="loader" class="hidden flex flex-col justify-center items-center h-24">
                <div class="loader mb-3"></div>
            </div>

            <div id="errorMessage" class="hidden text-center text-red-600 p-4 md:p-6 bg-red-50 rounded-lg border border-red-100 shadow-sm break-keep"></div>

            <!-- 요약 정보 카드 -->
            <div id="summaryCard" class="hidden bg-gradient-to-br from-gray-50 to-white border border-gray-200 rounded-xl p-5 mb-6 shadow-sm flex flex-col md:flex-row justify-between items-center gap-4 md:gap-8">
                <div class="text-center md:text-left">
                    <h2 id="companyName" class="text-xl md:text-2xl font-bold text-gray-800 leading-tight"></h2>
                    <p id="companyTicker" class="text-sm text-gray-500 font-semibold mt-1"></p>
                </div>
                <div class="flex flex-row gap-6 md:gap-12 w-full md:w-auto justify-center md:justify-end text-center md:text-right border-t md:border-t-0 border-gray-200 pt-4 md:pt-0 mt-2 md:mt-0">
                    <div>
                        <p class="text-xs md:text-sm text-gray-500 mb-1">현재 주가</p>
                        <div class="flex flex-col md:flex-row items-center md:items-baseline justify-center md:justify-end gap-1 md:gap-2">
                            <p id="currentPrice" class="text-2xl md:text-3xl font-bold text-gray-800 tracking-tight">-</p>
                            <span id="priceChange" class="text-xs md:text-sm font-bold px-2 py-0.5 rounded bg-gray-100 whitespace-nowrap">-</span>
                        </div>
                    </div>
                    <div>
                        <p class="text-xs md:text-sm text-gray-500 mb-1">시가총액 (Real-time)</p>
                        <p id="marketCap" class="text-xl md:text-2xl font-bold text-gray-800 tracking-tight">-</p>
                    </div>
                </div>
            </div>

            <!-- 옵션 라디오 버튼 -->
            <div id="optionsArea" class="hidden flex flex-col sm:flex-row justify-between items-center gap-4 md:gap-6 mb-4 transition-opacity duration-500 ease-in-out bg-gray-50 p-4 rounded-lg border border-gray-100 text-sm">
                <fieldset class="flex-1 sm:flex-none w-full sm:w-auto">
                    <div class="flex justify-center sm:justify-start gap-4 items-center h-full">
                        <span class="font-medium text-gray-600 mr-1 whitespace-nowrap">기간:</span>
                        <label class="flex items-center space-x-2 cursor-pointer hover:text-blue-600 transition-colors py-1">
                            <input type="radio" name="timeframe" value="annual" class="form-radio text-blue-600 focus:ring-blue-500 w-4 h-4" checked>
                            <span class="text-gray-800 font-medium">연간</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:text-blue-600 transition-colors py-1">
                            <input type="radio" name="timeframe" value="quarterly" class="form-radio text-blue-600 focus:ring-blue-500 w-4 h-4">
                            <span class="text-gray-800 font-medium">분기</span>
                        </label>
                    </div>
                </fieldset>

                <div class="block sm:hidden h-px bg-gray-200 w-full"></div>

                <fieldset class="flex-1 sm:flex-none w-full sm:w-auto">
                    <div class="flex justify-center sm:justify-end gap-4 items-center h-full">
                        <span class="font-medium text-gray-600 mr-1 whitespace-nowrap">통화:</span>
                        <label class="flex items-center space-x-2 cursor-pointer hover:text-blue-600 transition-colors py-1">
                            <input type="radio" name="currency" value="usd" class="form-radio text-blue-600 focus:ring-blue-500 w-4 h-4" checked>
                            <span class="text-gray-800 font-medium">달러 (USD)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:text-blue-600 transition-colors py-1">
                            <input type="radio" name="currency" value="krw" class="form-radio text-blue-600 focus:ring-blue-500 w-4 h-4">
                            <span class="text-gray-800 font-medium">원화 (KRW)</span>
                        </label>
                    </div>
                </fieldset>
            </div>

            <!-- 환율 정보 -->
            <div id="exchangeRateInfo" class="hidden mb-6 text-right text-xs text-gray-400 italic pr-1"></div>

            <!-- 결과 헤더 및 컨트롤 -->
            <div id="resultsHeaderContainer" class="hidden flex-col md:flex-row items-center justify-between mb-4 gap-4 border-t border-gray-200 pt-6">
                
                <div class="flex items-center gap-3 w-full md:w-auto justify-center md:justify-start">
                    <h2 id="resultsHeader" class="text-xl font-semibold text-gray-700 text-center md:text-left">재무 제표</h2>
                    <button id="toggleLayoutBtn" class="flex items-center gap-1 text-gray-600 bg-white border border-gray-300 hover:bg-gray-50 px-2 py-1 rounded text-xs font-medium transition-colors shadow-sm h-7">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        <span id="layoutBtnText">행/열 전환</span>
                    </button>
                </div>
                
                <!-- 예상 실적 계산기 (추가됨) -->
                <div id="calculatorContainer" class="flex items-center gap-2 bg-purple-50 px-3 py-2 rounded-lg border border-purple-100 shadow-sm w-full md:w-auto justify-center">
                    <label for="calcInput" class="text-xs text-purple-800 font-semibold whitespace-nowrap">예상 영업이익:</label>
                    <div class="relative">
                        <input type="number" id="calcInput" placeholder="0" class="w-20 bg-white border border-purple-200 rounded px-2 py-1 text-sm text-right focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500">
                        <span id="calcUnitLabel" class="absolute right-8 top-1/2 transform -translate-y-1/2 text-xs text-gray-400 pointer-events-none mr-1"></span>
                    </div>
                    <span id="calcUnitDisplay" class="text-xs text-purple-600 font-bold whitespace-nowrap"></span>
                    <span class="text-gray-400 text-xs">→</span>
                    <span id="calcResult" class="text-sm font-bold text-purple-700 w-12 text-center">-</span>
                </div>

                <!-- 연도 선택 슬라이더 -->
                <div id="sliderContainer" class="flex items-center gap-3 w-full md:w-auto justify-center md:justify-end bg-gray-50 px-3 py-2 rounded-lg border border-gray-200">
                    <span id="sliderLabel" class="text-sm font-medium text-gray-700 whitespace-nowrap w-20 text-right">최근 10년</span>
                    <input type="range" id="yearSlider" min="1" max="20" value="10" class="w-32 h-1.5 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-blue-600">
                </div>
            </div>

            <!-- 결과 목록 -->
            <div id="resultsList" class="space-y-4"></div>

            <!-- 차트 영역 -->
            <div id="chartContainer" class="hidden mt-8 p-4 md:p-6 bg-white rounded-xl border border-gray-200 shadow-sm">
                <h3 class="text-lg font-bold text-gray-800 mb-4">실적 추이</h3>
                <div class="relative h-64 md:h-80 w-full">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. DOM 요소 ---
        const tickerInput = document.getElementById('tickerInput');
        const searchButton = document.getElementById('searchButton');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('errorMessage');
        const resultsHeaderContainer = document.getElementById('resultsHeaderContainer');
        const resultsHeader = document.getElementById('resultsHeader');
        const resultsList = document.getElementById('resultsList');
        const exchangeRateInfo = document.getElementById('exchangeRateInfo');
        const optionsArea = document.getElementById('optionsArea');
        const autocompleteList = document.getElementById('autocomplete-list');
        const toggleLayoutBtn = document.getElementById('toggleLayoutBtn');
        const layoutBtnText = document.getElementById('layoutBtnText');
        const sliderContainer = document.getElementById('sliderContainer');
        const yearSlider = document.getElementById('yearSlider');
        const sliderLabel = document.getElementById('sliderLabel');
        const summaryCard = document.getElementById('summaryCard');
        const companyName = document.getElementById('companyName');
        const companyTicker = document.getElementById('companyTicker');
        const currentPrice = document.getElementById('currentPrice');
        const priceChange = document.getElementById('priceChange');
        const marketCap = document.getElementById('marketCap');
        const chartContainer = document.getElementById('chartContainer');
        
        // 계산기 요소
        const calculatorContainer = document.getElementById('calculatorContainer');
        const calcInput = document.getElementById('calcInput');
        const calcUnitDisplay = document.getElementById('calcUnitDisplay');
        const calcResult = document.getElementById('calcResult');

        // --- 2. API 설정 ---
        const ALPHA_VANTAGE_API_KEYS = ["IOLM32O12PSE4LDJ", "Q3H5NC59JKHFVB7X", "5I1RLIUUUEEM3LSR"];
        const KEXIM_API_KEY = "ixCOgz4fZCVMO1h0wypjsh6r75on2HlP"; 

        // --- 3. 전역 상태 ---
        let currentTimeframe = 'annual';
        let currentCurrency = 'usd';
        let usdToKrwRate = 1430; 
        let fetchedData = null; 
        let tickerList = []; 
        let isVerticalView = true; 
        let myChart = null;
        let currentMarketCapRaw = 0; // 실시간 시가총액(Raw Value) 저장용
        let calculatorBaseUnit = 1; // 계산기 입력값의 단위 (예: 10억)

        // --- 4. 초기화 및 이벤트 리스너 ---
        window.addEventListener('DOMContentLoaded', async () => {
            await fetchTickerData();
        });

        async function fetchTickerData() {
            try {
                const response = await fetch('https://corsproxy.io/?https://www.sec.gov/files/company_tickers.json');
                const data = await response.json();
                tickerList = Object.values(data);
            } catch (e) { console.warn("Ticker load failed", e); }
        }

        tickerInput.addEventListener('input', function() {
            const val = this.value;
            closeAutocomplete();
            if (!val || val.length < 1) return;
            const matches = filterCompanies(val);
            if (matches.length > 0) showAutocomplete(matches);
        });

        tickerInput.addEventListener('focus', function() {
            if (this.value.length >= 1) {
                const matches = filterCompanies(this.value);
                if (matches.length > 0) showAutocomplete(matches);
            }
        });

        document.addEventListener('click', function(e) {
            if (e.target !== tickerInput && e.target.parentNode !== autocompleteList) closeAutocomplete();
        });

        function filterCompanies(query) {
            if (!tickerList.length) return [];
            const q = query.toUpperCase();
            return tickerList.filter(c => c.ticker.startsWith(q) || c.title.toUpperCase().includes(q)).slice(0, 10); 
        }

        function showAutocomplete(matches) {
            autocompleteList.innerHTML = '';
            matches.forEach(match => {
                const li = document.createElement('li');
                li.className = "px-4 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0 flex justify-between items-center";
                li.innerHTML = `<div><span class="font-bold text-gray-800 w-16 inline-block">${match.ticker}</span><span class="text-sm text-gray-600 truncate max-w-[200px] sm:max-w-xs inline-block align-bottom">${match.title}</span></div>`;
                li.addEventListener('click', () => {
                    tickerInput.value = match.ticker;
                    closeAutocomplete();
                    searchFilings(); 
                });
                autocompleteList.appendChild(li);
            });
            autocompleteList.classList.remove('hidden');
        }

        function closeAutocomplete() {
            autocompleteList.innerHTML = '';
            autocompleteList.classList.add('hidden');
        }

        searchButton.addEventListener('click', searchFilings);
        tickerInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                closeAutocomplete();
                searchFilings();
            }
        });

        document.querySelectorAll('input[name="timeframe"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                currentTimeframe = e.target.value;
                if (currentTimeframe === 'annual') {
                    yearSlider.value = 10;
                    sliderLabel.textContent = `최근 10년`;
                } else {
                    yearSlider.value = 3; 
                    sliderLabel.textContent = `최근 3년`;
                }
                if (fetchedData) displayResults(fetchedData.ticker, fetchedData);
            });
        });

        document.querySelectorAll('input[name="currency"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                currentCurrency = e.target.value;
                if (fetchedData) {
                    displayResults(fetchedData.ticker, fetchedData);
                    updateExchangeRateInfo();
                }
            });
        });

        toggleLayoutBtn.addEventListener('click', () => {
            isVerticalView = !isVerticalView;
            if (fetchedData) displayResults(fetchedData.ticker, fetchedData);
        });

        yearSlider.addEventListener('input', (e) => {
            const years = e.target.value;
            sliderLabel.textContent = `최근 ${years}년`;
            if (fetchedData) displayResults(fetchedData.ticker, fetchedData);
        });
        
        // --- 계산기 로직 ---
        calcInput.addEventListener('input', updateCalculator);
        
        function updateCalculator() {
            const val = parseFloat(calcInput.value);
            if (!val || val === 0 || !currentMarketCapRaw) {
                calcResult.textContent = '-';
                return;
            }
            
            // 입력값(val) * 단위(calculatorBaseUnit) = 예상 영업이익
            // Market Cap / 예상 영업이익 = Multiple
            const expectedOpIncome = val * calculatorBaseUnit;
            const multiple = currentMarketCapRaw / expectedOpIncome;
            
            calcResult.textContent = multiple.toFixed(2) + 'x';
        }

        function setupCalculator(latestOpIncome) {
            // latestOpIncome은 이미 환율이 적용된 상태의 값이라고 가정하거나,
            // 여기서 통화에 맞춰 단위를 설정해야 함.
            // fetchedData 저장 시 raw data가 저장됨.
            // 따라서 화면에 표시되는 통화(currentCurrency)에 맞춰 단위를 결정.
            
            let factor = 1;
            if (currentCurrency === 'krw' && usdToKrwRate) factor = usdToKrwRate;
            
            const incomeInCurrentCurrency = latestOpIncome * factor;
            const mktCapInCurrentCurrency = currentMarketCapRaw; // 이미 update 함수에서 처리? No.
            // currentMarketCapRaw는 USD 기준 원본이어야 함.
            // 하지만 사용자 입력은 "현재 보이는 통화" 기준임.
            // 따라서 비교 대상인 시가총액도 현재 통화로 변환 필요.
            
            const mktCapForCalc = currentMarketCapRaw * factor;
            
            // 단위 결정 로직 (최근 영업이익 규모 기준)
            if (currentCurrency === 'krw') {
                if (Math.abs(incomeInCurrentCurrency) >= 1_000_000_000_000) {
                    calculatorBaseUnit = 1_000_000_000_000 / factor; // 입력값 1 = 1조 (USD로 환산해 저장) -> 아니요, 계산은 다 환산된 뒤에 하는게 나음.
                    // 간단히: 입력값(화면단위) -> 실제값(화면단위) -> 비율 계산
                    // 따라서 baseUnit은 화면 표시 단위에 맞춤.
                    calculatorBaseUnit = 1_000_000_000_000; 
                    calcUnitDisplay.textContent = '조원';
                    calcInput.placeholder = (incomeInCurrentCurrency / 1_000_000_000_000).toFixed(1);
                } else {
                    calculatorBaseUnit = 100_000_000;
                    calcUnitDisplay.textContent = '억원';
                    calcInput.placeholder = (incomeInCurrentCurrency / 100_000_000).toFixed(0);
                }
            } else {
                // USD
                if (Math.abs(incomeInCurrentCurrency) >= 1_000_000_000) {
                    calculatorBaseUnit = 1_000_000_000;
                    calcUnitDisplay.textContent = '$B';
                    calcInput.placeholder = (incomeInCurrentCurrency / 1_000_000_000).toFixed(1);
                } else {
                    calculatorBaseUnit = 1_000_000;
                    calcUnitDisplay.textContent = '$M';
                    calcInput.placeholder = (incomeInCurrentCurrency / 1_000_000).toFixed(0);
                }
            }
            
            // 재계산을 위해 전역 변수에 현재 통화 기준 시가총액 저장 (임시로 덮어쓰기 X, 별도 변수 쓰거나 여기서 계산)
            // updateCalculator에서 쓸 전역 변수를 "현재 통화 기준 시가총액"으로 업데이트
            currentMarketCapRaw = mktCapForCalc; 
            calcInput.value = ''; // 초기화
            calcResult.textContent = '-';
        }


        // --- 5. 헬퍼 함수 ---
        function formatNumber(num, format = 'default') {
            if (num === null || num === undefined || num === 'N/A' || isNaN(num)) return 'N/A';
            num = parseFloat(num); 
            if (format === 'percent') return (num * 100).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + '%';
            if (format === 'ratio') return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + 'x';
            let value = num;
            if (currentCurrency === 'krw' && usdToKrwRate) {
                value = num * usdToKrwRate;
                if (Math.abs(value) >= 1_000_000_000_000) return (value / 1_000_000_000_000).toFixed(2) + '조';
                if (Math.abs(value) >= 100_000_000) return (value / 100_000_000).toFixed(2) + '억';
                if (Math.abs(value) >= 10_000) return (value / 10_000).toFixed(2) + '만';
                return value.toLocaleString('ko-KR', { maximumFractionDigits: 0 }) + '원';
            } else {
                if (Math.abs(value) >= 1_000_000_000_000) return (value / 1_000_000_000_000).toFixed(2) + 'T';
                if (Math.abs(value) >= 1_000_000_000) return (value / 1_000_000_000).toFixed(2) + 'B';
                if (Math.abs(value) >= 1_000_000) return (value / 1_000_000).toFixed(2) + 'M';
                return value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
        }
        
        function formatPrice(num) {
            if (num === null || num === undefined || isNaN(num)) return '-';
            num = parseFloat(num);
            if (currentCurrency === 'krw' && usdToKrwRate) return (num * usdToKrwRate).toLocaleString('ko-KR', { maximumFractionDigits: 0 }) + '원';
            return '$' + num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            try { return dateStr.substring(0, 4); } catch (e) { return dateStr; }
        }
        
        function formatFullDate(dateStr) {
            if (!dateStr) return 'N/A';
            try { return dateStr.substring(0, 10); } catch (e) { return dateStr; }
        }

        function getQuarter(dateStr, fiscalEndMonth) {
            if (!dateStr) return '';
            try {
                const month = parseInt(dateStr.substring(5, 7));
                let diff = (month - fiscalEndMonth + 12) % 12;
                if (diff === 0) diff = 12;
                return 'Q' + Math.ceil(diff / 3);
            } catch (e) { return ''; }
        }

        function updateExchangeRateInfo(source = '기본값') {
            if (currentCurrency === 'krw' && usdToKrwRate) {
                exchangeRateInfo.textContent = `적용 환율: ${usdToKrwRate.toLocaleString()}원/USD (${source})`;
                exchangeRateInfo.classList.remove('hidden');
            } else {
                exchangeRateInfo.classList.add('hidden');
            }
        }

        // --- 6. API 관련 함수 ---
        async function fetchWithTimeout(resource, options = {}) {
            const { timeout = 5000 } = options;
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            const response = await fetch(resource, { ...options, signal: controller.signal });
            clearTimeout(id);
            return response;
        }

        async function getExchangeRate() {
            const keximRate = await getKeximRateRecursive();
            if (keximRate) return { rate: keximRate, source: '한국수출입은행' };
            try {
                const res = await fetchWithTimeout('https://open.er-api.com/v6/latest/USD');
                const json = await res.json();
                if (json?.rates?.KRW) return { rate: json.rates.KRW, source: 'Open Exchange Rates' };
            } catch (e) { console.warn('Fallback API failed', e); }
            return { rate: 1430, source: '기본값 (API 연결 실패)' };
        }

        async function getKeximRateRecursive(attempt = 0) {
            if (!KEXIM_API_KEY || attempt > 7) return null;
            const date = new Date();
            date.setDate(date.getDate() - attempt);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const searchDate = `${year}${month}${day}`;
            const url = `https://www.koreaexim.go.kr/site/program/financial/exchangeJSON?authkey=${KEXIM_API_KEY}&searchdate=${searchDate}&data=AP01`;
            const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(url);
            try {
                const res = await fetchWithTimeout(proxyUrl, { timeout: 4000 });
                if (!res.ok) throw new Error('Network error');
                const json = await res.json();
                if (Array.isArray(json)) {
                    const usdData = json.find(item => item.cur_unit === 'USD');
                    if (usdData) return parseFloat(usdData.deal_bas_r.replace(/,/g, ''));
                }
                return await getKeximRateRecursive(attempt + 1);
            } catch (e) { return await getKeximRateRecursive(attempt + 1); }
        }

        async function fetchAlphaVantage(fn, ticker, initialKeyIndex, retries = 5) {
            let currentKeyIndex = initialKeyIndex;
            for (let i = 0; i <= retries; i++) {
                const apiKey = ALPHA_VANTAGE_API_KEYS[currentKeyIndex % ALPHA_VANTAGE_API_KEYS.length];
                const url = `https://www.alphavantage.co/query?function=${fn}&symbol=${ticker}&apikey=${apiKey}`;
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    const data = await res.json();
                    if (data['Information'] || data['Note']) {
                        if (i < retries) {
                            currentKeyIndex++;
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            continue;
                        }
                    }
                    return data;
                } catch (e) {
                    if (i < retries) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        continue;
                    }
                    throw e;
                }
            }
            return { 'Error Message': 'Max retries exceeded' };
        }

        async function searchFilings() {
            const ticker = tickerInput.value.trim().toUpperCase();
            if (!ticker) {
                showError('티커를 입력하세요.');
                return;
            }
            showLoader(true);
            showError(null);
            resetUI();
            fetchedData = null;

            try {
                const functions = ['INCOME_STATEMENT', 'BALANCE_SHEET', 'EARNINGS', 'OVERVIEW', 'GLOBAL_QUOTE'];
                const promises = functions.map(async (fn, index) => {
                    await new Promise(resolve => setTimeout(resolve, index * 600));
                    return fetchAlphaVantage(fn, ticker, index);
                });
                const exchangeRatePromise = getExchangeRate();
                const results = await Promise.all([...promises, exchangeRatePromise]);
                const [incomeData, balanceData, earningsData, overviewData, quoteData, exchangeRateData] = results;

                const getError = (d, name) => {
                    if (!d) return `${name} 데이터 없음`;
                    if (d['Error Message']) return d['Error Message'];
                    if (d['Information'] || d['Note']) return 'API 한도 초과';
                    return null;
                };
                const errorMsg = getError(incomeData, '수익') || getError(balanceData, '대차대조표') || 
                                 getError(earningsData, 'EPS') || getError(overviewData, '개요') || getError(quoteData, '주가');
                if (errorMsg) throw new Error(errorMsg.includes('limit') || errorMsg === 'API 한도 초과' ? 'API 한도 초과' : errorMsg);
                if (!incomeData.annualReports && !incomeData.quarterlyReports) throw new Error('재무 데이터를 찾을 수 없습니다.');

                usdToKrwRate = exchangeRateData.rate;
                document.querySelector('input[name="currency"][value="krw"]').disabled = false;

                fetchedData = { ticker, income: incomeData, balance: balanceData, earnings: earningsData, overview: overviewData, quote: quoteData['Global Quote'] || {}, exchangeSource: exchangeRateData.source };
                optionsArea.classList.remove('hidden'); 
                
                if (currentTimeframe === 'annual') {
                    yearSlider.value = 10;
                    sliderLabel.textContent = `최근 10년`;
                } else {
                    yearSlider.value = 3; 
                    sliderLabel.textContent = `최근 3년`;
                }

                displayResults(ticker, fetchedData);
                updateExchangeRateInfo(fetchedData.exchangeSource);
            } catch (error) {
                let msg = error.message;
                let showBtn = false;
                if (msg.includes('API 한도') || msg.includes('limit')) {
                    msg = 'API 호출 한도를 초과했습니다.<br>잠시 후 다시 시도해주세요.';
                    showBtn = true;
                }
                showError(msg, showBtn);
            } finally {
                showLoader(false);
            }
        }

        function displayResults(ticker, allData) {
            const { income, balance, earnings, overview, quote } = allData;
            
            resultsHeaderContainer.classList.remove('hidden');
            resultsHeaderContainer.classList.add('flex');
            summaryCard.classList.remove('hidden');
            calculatorContainer.classList.remove('hidden'); // 계산기 표시
            
            companyName.textContent = overview?.Name || ticker;
            companyTicker.textContent = ticker;
            
            const price = parseFloat(quote['05. price']);
            const shares = parseFloat(overview?.SharesOutstanding);
            const changePercent = parseFloat((quote['10. change percent'] || '0').replace('%', ''));
            
            priceChange.textContent = `${changePercent >= 0 ? '▲' : '▼'} ${Math.abs(changePercent).toFixed(2)}%`;
            priceChange.className = `text-xs md:text-sm font-bold px-2 py-0.5 rounded whitespace-nowrap ${changePercent >= 0 ? 'text-red-600 bg-red-50' : changePercent < 0 ? 'text-blue-600 bg-blue-50' : 'text-gray-600 bg-gray-50'}`;
            currentPrice.className = `text-2xl md:text-3xl font-bold tracking-tight ${changePercent >= 0 ? 'text-red-600' : changePercent < 0 ? 'text-blue-600' : 'text-gray-800'}`;
            
            let mktCap = parseFloat(overview?.MarketCapitalization);
            if (price && shares) {
                const calculatedMktCap = price * shares;
                const apiMktCap = parseFloat(overview?.MarketCapitalization);
                const diffRatio = Math.abs(calculatedMktCap - apiMktCap) / apiMktCap;
                if (diffRatio < 0.2) mktCap = calculatedMktCap;
            } else if (price && shares) {
                mktCap = price * shares;
            }
            const apiMktCap = parseFloat(overview?.MarketCapitalization);
            
            // 전역 시가총액 변수 업데이트 (USD 기준)
            currentMarketCapRaw = mktCap;

            currentPrice.textContent = formatPrice(price);
            marketCap.textContent = formatNumber(mktCap);

            const reports = currentTimeframe === 'annual' ? income.annualReports : income.quarterlyReports;
            if (!reports || reports.length === 0) {
                showError('해당 기간의 데이터가 없습니다.');
                return;
            }

            // 계산기 설정 (최신 영업이익 기준)
            if (reports.length > 0) {
                const latestOp = parseFloat(reports[0].operatingIncome);
                // 분기일 경우 연환산(x4)하여 계산기 기준 설정? 보통 연간 기준이므로 연간 보고서나 분기*4 사용
                // 여기서는 현재 보고서 기준
                let baseOp = latestOp;
                if (currentTimeframe === 'quarterly') baseOp = latestOp * 4;
                setupCalculator(baseOp);
            }

            const yearsToShow = parseInt(yearSlider.value);
            const countToShow = currentTimeframe === 'annual' ? yearsToShow : yearsToShow * 4;
            const filteredReports = reports.slice(0, countToShow);
            
            const yearHeaders = filteredReports.map(d => d.fiscalDateEnding);
            
            let fiscalEndMonth = 12; 
            if (income.annualReports && income.annualReports.length > 0) {
                const latestDate = income.annualReports[0].fiscalDateEnding;
                fiscalEndMonth = parseInt(latestDate.substring(5, 7));
            }
            
            try {
                renderChart(filteredReports, fiscalEndMonth);
            } catch(e) { console.warn(e); }

            const keyMetrics = [
                { 
                    label: '매출', 
                    key: 'totalRevenue', 
                    format: 'default',
                    getValue: (d, all) => (currentTimeframe==='annual'?all.income.annualReports:all.income.quarterlyReports).find(r=>r.fiscalDateEnding===d)?.totalRevenue 
                },
                { 
                    label: '영업이익', 
                    key: 'operatingIncome', 
                    format: 'default',
                    getValue: (d, all) => (currentTimeframe==='annual'?all.income.annualReports:all.income.quarterlyReports).find(r=>r.fiscalDateEnding===d)?.operatingIncome
                },
                { 
                    label: '영업이익율', 
                    computed: (r) => {
                        const rev = parseFloat(r.totalRevenue);
                        const op = parseFloat(r.operatingIncome);
                        return (rev && op) ? op/rev : null; 
                    }, 
                    format: 'percent',
                    getValue: (d, all) => {
                        const r = (currentTimeframe==='annual'?all.income.annualReports:all.income.quarterlyReports).find(rep=>rep.fiscalDateEnding===d);
                        if(!r) return null;
                        return (parseFloat(r.operatingIncome)/parseFloat(r.totalRevenue));
                    }
                },
                { 
                    label: '시가총액 / 영업이익', 
                    computed: (r) => {
                        const op = parseFloat(r.operatingIncome);
                        if(!op || op===0) return null;
                        return mktCap / (currentTimeframe === 'quarterly' ? op * 4 : op);
                    }, 
                    format: 'ratio',
                    getValue: (d, all) => {
                        const r = (currentTimeframe==='annual'?all.income.annualReports:all.income.quarterlyReports).find(rep=>rep.fiscalDateEnding===d);
                        if(!r) return null;
                        const op = parseFloat(r.operatingIncome);
                        if(!op || op===0) return null;
                        return mktCap / (currentTimeframe === 'quarterly' ? op * 4 : op);
                    }
                }
            ];

            let html = `<div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
                        <table class="w-full min-w-max text-left border-collapse border-hidden">`;

            if (!isVerticalView) {
                // 가로 보기
                html += `<thead class="bg-gray-100"><tr>
                            <th class="p-2 border border-gray-300 font-semibold text-gray-700 sticky left-0 z-10 bg-gray-100 whitespace-nowrap text-center text-sm">지표</th>`;
                yearHeaders.forEach(date => {
                     let dateLabel = date.substring(0, 4);
                     if (currentTimeframe === 'quarterly') {
                         dateLabel += ` <span class="text-gray-500 font-normal ml-0.5">${getQuarter(date, fiscalEndMonth)}</span>`;
                     }
                     html += `<th class="p-2 border border-gray-300 font-semibold text-gray-700 text-center whitespace-nowrap text-sm">
                        <span class="block">${dateLabel}</span>
                        <span class="block text-xs font-normal text-gray-500">${formatFullDate(date)}</span>
                    </th>`;
                });
                html += `</tr></thead><tbody>`;

                keyMetrics.forEach(metric => {
                    html += `<tr class="even:bg-gray-50 hover:bg-gray-100 transition-colors">
                        <td class="p-2 border border-gray-300 font-medium text-gray-800 sticky left-0 z-10 bg-white even:bg-gray-50 hover:bg-gray-100 whitespace-nowrap text-center text-sm shadow-[1px_0_0_0_rgba(0,0,0,0.05)]">${metric.label}</td>`;
                    
                    yearHeaders.forEach((date, colIndex) => {
                        let val = metric.getValue(date, allData);
                        let growthHtml = '';
                        if (metric.label !== '시가총액 / 영업이익') {
                            const currentIndexInAll = reports.findIndex(r => r.fiscalDateEnding === date);
                            const prevIndex = currentIndexInAll + (currentTimeframe === 'annual' ? 1 : 4);
                            
                            if (prevIndex < reports.length) {
                                const prevDate = reports[prevIndex].fiscalDateEnding;
                                const prevVal = metric.getValue(prevDate, allData);
                                if (val !== null && prevVal !== null && !isNaN(val) && !isNaN(prevVal) && prevVal != 0) {
                                    let change, changeStr, colorClass;
                                    if (metric.format === 'percent') {
                                        change = (val - prevVal) * 100; 
                                        colorClass = change > 0 ? 'text-red-500' : change < 0 ? 'text-blue-500' : 'text-gray-400';
                                        changeStr = `${change > 0 ? '▲' : change < 0 ? '▼' : ''} ${Math.abs(change).toFixed(1)}%p`;
                                    } else {
                                        change = ((val - prevVal) / Math.abs(prevVal)) * 100;
                                        colorClass = change > 0 ? 'text-red-500' : change < 0 ? 'text-blue-500' : 'text-gray-400';
                                        changeStr = `${change > 0 ? '▲' : change < 0 ? '▼' : ''} ${Math.abs(change).toFixed(1)}%`;
                                    }
                                    growthHtml = `<span class="block text-xs ${colorClass} mt-0.5 font-semibold">${changeStr}</span>`;
                                }
                            }
                        }

                        // 가로 보기: 실적(위) / 증감률(아래)
                        html += `<td class="p-2 border border-gray-300 text-right font-mono whitespace-nowrap align-top text-sm">
                            <div class="font-bold text-gray-900 mb-1">${formatNumber(val, metric.format)}</div>
                            ${growthHtml}
                        </td>`;
                    });
                    html += `</tr>`;
                });
                html += `</tbody>`;

            } else {
                // 세로 보기
                html += `<thead class="bg-gray-100"><tr>
                            <th class="p-1 border border-gray-300 font-semibold text-gray-700 sticky left-0 z-10 bg-gray-100 whitespace-nowrap text-center text-sm">기간</th>`;
                keyMetrics.forEach(metric => {
                    html += `<th class="p-1 border border-gray-300 font-semibold text-gray-700 text-center whitespace-nowrap text-sm">${metric.label}</th>`;
                });
                html += `</tr></thead><tbody>`;

                yearHeaders.forEach((date, rowIndex) => {
                    let dateLabel = date.substring(0, 4);
                    if (currentTimeframe === 'quarterly') {
                        dateLabel += ` <span class="font-normal text-gray-600 ml-0.5">${getQuarter(date, fiscalEndMonth)}</span>`;
                    }
                    
                    html += `<tr class="even:bg-gray-50 hover:bg-gray-100 transition-colors">
                        <td class="p-1 border border-gray-300 font-medium text-gray-800 sticky left-0 z-10 bg-white even:bg-gray-50 hover:bg-gray-100 whitespace-nowrap shadow-[1px_0_0_0_rgba(0,0,0,0.05)] text-center text-sm">
                             <span class="font-bold">${dateLabel}</span>
                             <span class="text-xs text-gray-500 ml-1">(${formatFullDate(date)})</span>
                        </td>`;
                    
                    keyMetrics.forEach(metric => {
                        let val = metric.getValue(date, allData);
                        
                        let growthHtml = '';
                        if (metric.label !== '시가총액 / 영업이익') {
                            const currentIndexInAll = reports.findIndex(r => r.fiscalDateEnding === date);
                            const prevIndex = currentIndexInAll + (currentTimeframe === 'annual' ? 1 : 4);
                            
                            if (prevIndex < reports.length) {
                                const prevDate = reports[prevIndex].fiscalDateEnding;
                                const prevVal = metric.getValue(prevDate, allData);
                                
                                if (val !== null && prevVal !== null && !isNaN(val) && !isNaN(prevVal) && prevVal != 0) {
                                    let change, changeStr, colorClass;
                                    if (metric.format === 'percent') {
                                        change = (val - prevVal) * 100; 
                                        colorClass = change > 0 ? 'text-red-500' : change < 0 ? 'text-blue-500' : 'text-gray-400';
                                        changeStr = `${change > 0 ? '▲' : change < 0 ? '▼' : ''} ${Math.abs(change).toFixed(1)}%p`;
                                    } else {
                                        change = ((val - prevVal) / Math.abs(prevVal)) * 100;
                                        colorClass = change > 0 ? 'text-red-500' : change < 0 ? 'text-blue-500' : 'text-gray-400';
                                        changeStr = `${change > 0 ? '▲' : change < 0 ? '▼' : ''} ${Math.abs(change).toFixed(1)}%`;
                                    }
                                    growthHtml = `<span class="inline-block ml-1.5 text-xs ${colorClass} font-semibold">(${changeStr})</span>`;
                                }
                            }
                        }

                        let cellContent;
                        if (metric.label === '시가총액 / 영업이익') {
                             cellContent = `<div class="flex justify-center items-center h-full"><span class="font-bold text-gray-900">${formatNumber(val, metric.format)}</span></div>`;
                        } else {
                             cellContent = `<div class="flex items-center justify-start h-full">
                                <span class="w-[11ch] text-right font-bold text-gray-900 shrink-0">${formatNumber(val, metric.format)}</span>
                                ${growthHtml}
                            </div>`;
                        }

                        html += `<td class="p-1 border border-gray-300 text-sm font-mono whitespace-nowrap">
                            ${cellContent}
                        </td>`;
                    });
                    html += `</tr>`;
                });
                html += `</tbody>`;
            }

            html += `</table></div>`;
            resultsList.innerHTML = html;
        }

        function resetUI() {
            resultsList.innerHTML = '';
            exchangeRateInfo.classList.add('hidden');
            resultsHeaderContainer.classList.add('hidden');
            optionsArea.classList.add('hidden'); 
            summaryCard.classList.add('hidden');
            chartContainer.classList.add('hidden');
            calculatorContainer.classList.add('hidden');
        }

        function resetApp() {
            showError(null);
            loader.classList.add('hidden');
            resetUI();
            tickerInput.value = '';
            tickerInput.focus();
        }

        function showError(message, withButton = false) {
            if (message) {
                errorMessage.innerHTML = `
                    <div class="flex flex-col items-center">
                        <p class="font-medium mb-2">⚠️ 오류</p>
                        <p class="text-sm text-gray-700 mb-4">${message}</p>
                        ${withButton ? `<button onclick="resetApp()" class="bg-white text-red-600 border border-red-200 px-6 py-2 rounded-lg text-sm font-bold shadow-sm">돌아가기</button>` : ''}
                    </div>
                `;
                errorMessage.classList.remove('hidden');
            } else {
                errorMessage.classList.add('hidden');
            }
        }

        function showLoader(show) {
            if (show) loader.classList.remove('hidden');
            else loader.classList.add('hidden');
        }
    </script>
</body>
</html>