<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê¸°ì—… ì‹¤ì  ê²€ìƒ‰ê¸°</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .overflow-x-auto {
            -webkit-overflow-scrolling: touch;
        }
        /* ìë™ì™„ì„± ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        #autocomplete-list::-webkit-scrollbar {
            width: 6px;
        }
        #autocomplete-list::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }
        #autocomplete-list::-webkit-scrollbar-track {
            background-color: #f1f5f9;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans py-6 px-4 sm:px-6 lg:px-8">
    <div class="bg-white p-6 md:p-12 rounded-lg shadow-xl w-full max-w-5xl mx-auto my-4">
        <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-4 md:mb-6">ê¸°ì—… ì‹¤ì  ê²€ìƒ‰ê¸°</h1>
        <p class="text-center text-gray-600 mb-6 md:mb-8 text-sm md:text-base">ë¯¸êµ­ ìƒì¥ ê¸°ì—…ì˜ í‹°ì»¤(Ticker)ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: AAPL, MSFT, IBM)</p>
        
        <!-- ê²€ìƒ‰ í¼ -->
        <div class="flex flex-col sm:flex-row gap-3 mb-6 md:mb-8 relative">
            <!-- ì…ë ¥ì°½ ë˜í¼ -->
            <div class="relative flex-grow">
                <input type="text" id="tickerInput" placeholder="í‹°ì»¤ ë˜ëŠ” íšŒì‚¬ëª… ì…ë ¥ (ì˜ˆ: AAPL, Apple)" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow text-lg" 
                       autocomplete="off" autocapitalize="characters">
                
                <!-- ìë™ì™„ì„± ëª©ë¡ -->
                <ul id="autocomplete-list" class="hidden absolute z-50 w-full bg-white border border-gray-200 rounded-lg shadow-lg mt-1 max-h-60 overflow-y-auto text-left"></ul>
            </div>

            <button id="searchButton" class="w-full sm:w-auto bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors text-lg shadow-sm active:bg-blue-800">
                ê²€ìƒ‰
            </button>
        </div>

        <!-- ë¡œë”© ë° ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
        <div id="resultsArea">
            <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
            <div id="loader" class="hidden flex flex-col justify-center items-center h-24">
                <div class="loader mb-3"></div>
            </div>

            <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
            <div id="errorMessage" class="hidden text-center text-red-600 p-4 md:p-6 bg-red-50 rounded-lg border border-red-100 shadow-sm break-keep"></div>

            <!-- ìš”ì•½ ì •ë³´ ì¹´ë“œ -->
            <div id="summaryCard" class="hidden bg-gradient-to-br from-gray-50 to-white border border-gray-200 rounded-xl p-5 mb-6 shadow-sm flex flex-col md:flex-row justify-between items-center gap-4 md:gap-8">
                <div class="text-center md:text-left">
                    <h2 id="companyName" class="text-xl md:text-2xl font-bold text-gray-800 leading-tight"></h2>
                    <p id="companyTicker" class="text-sm text-gray-500 font-semibold mt-1"></p>
                </div>
                <div class="flex flex-row gap-6 md:gap-12 w-full md:w-auto justify-center md:justify-end text-center md:text-right border-t md:border-t-0 border-gray-200 pt-4 md:pt-0 mt-2 md:mt-0">
                    <div>
                        <p class="text-xs md:text-sm text-gray-500 mb-1">í˜„ì¬ ì£¼ê°€</p>
                        <div class="flex flex-col md:flex-row items-center md:items-baseline justify-center md:justify-end gap-1 md:gap-2">
                            <p id="currentPrice" class="text-2xl md:text-3xl font-bold text-gray-800 tracking-tight">-</p>
                            <span id="priceChange" class="text-xs md:text-sm font-bold px-2 py-0.5 rounded bg-gray-100 whitespace-nowrap">-</span>
                        </div>
                    </div>
                    <div>
                        <p class="text-xs md:text-sm text-gray-500 mb-1">ì‹œê°€ì´ì•¡ (Real-time)</p>
                        <p id="marketCap" class="text-xl md:text-2xl font-bold text-gray-800 tracking-tight">-</p>
                    </div>
                </div>
            </div>

            <!-- ì˜µì…˜ ë¼ë””ì˜¤ ë²„íŠ¼ -->
            <div id="optionsArea" class="hidden flex flex-col sm:flex-row justify-between sm:justify-end gap-4 md:gap-6 mb-4 transition-opacity duration-500 ease-in-out bg-gray-50 p-4 rounded-lg border border-gray-100 text-sm">
                <fieldset class="flex-1 sm:flex-none">
                    <div class="flex justify-center sm:justify-start gap-4 items-center h-full">
                        <span class="font-medium text-gray-600 mr-1 whitespace-nowrap">ê¸°ê°„:</span>
                        <label class="flex items-center space-x-2 cursor-pointer hover:text-blue-600 transition-colors py-1">
                            <input type="radio" name="timeframe" value="annual" class="form-radio text-blue-600 focus:ring-blue-500 w-4 h-4" checked>
                            <span class="text-gray-800 font-medium">ì—°ê°„</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:text-blue-600 transition-colors py-1">
                            <input type="radio" name="timeframe" value="quarterly" class="form-radio text-blue-600 focus:ring-blue-500 w-4 h-4">
                            <span class="text-gray-800 font-medium">ë¶„ê¸°</span>
                        </label>
                    </div>
                </fieldset>
                <div class="hidden sm:block w-px bg-gray-300 mx-2"></div>
                <div class="block sm:hidden h-px bg-gray-200 w-full"></div>
                <fieldset class="flex-1 sm:flex-none">
                    <div class="flex justify-center sm:justify-start gap-4 items-center h-full">
                        <span class="font-medium text-gray-600 mr-1 whitespace-nowrap">í†µí™”:</span>
                        <label class="flex items-center space-x-2 cursor-pointer hover:text-blue-600 transition-colors py-1">
                            <input type="radio" name="currency" value="usd" class="form-radio text-blue-600 focus:ring-blue-500 w-4 h-4" checked>
                            <span class="text-gray-800 font-medium">ë‹¬ëŸ¬ (USD)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:text-blue-600 transition-colors py-1">
                            <input type="radio" name="currency" value="krw" class="form-radio text-blue-600 focus:ring-blue-500 w-4 h-4">
                            <span class="text-gray-800 font-medium">ì›í™” (KRW)</span>
                        </label>
                    </div>
                </fieldset>
            </div>

            <!-- í™˜ìœ¨ ì •ë³´ -->
            <div id="exchangeRateInfo" class="hidden mb-6 text-right text-xs text-gray-400 italic pr-1"></div>

            <!-- ê²°ê³¼ í—¤ë” -->
            <div id="resultsHeaderContainer" class="hidden flex-col md:flex-row items-center justify-between mb-4 gap-4 border-t border-gray-200 pt-6">
                <h2 id="resultsHeader" class="text-xl font-semibold text-gray-700 w-full md:w-auto text-center md:text-left">ì¬ë¬´ ì œí‘œ</h2>
                <button id="aiSummaryButton" class="hidden w-full md:w-auto bg-gradient-to-r from-purple-500 to-blue-500 text-white px-5 py-2.5 rounded-lg font-semibold hover:from-purple-600 hover:to-blue-600 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-all shadow-md text-sm">
                    âœ¨ AI ì¬ë¬´ ìš”ì•½
                </button>
            </div>

            <!-- AI ìš”ì•½ ê²°ê³¼ -->
            <div id="aiSummaryArea" class="hidden mb-6">
                <div id="aiLoader" class="hidden flex items-center justify-center p-4 bg-gray-50 rounded-lg">
                    <div class="loader border-2 w-6 h-6 mr-3"></div>
                    <span class="text-gray-600 text-sm">AI ë¶„ì„ ì¤‘...</span>
                </div>
                <div id="aiSummaryContent" class="hidden p-5 bg-blue-50 border-l-4 border-blue-400 rounded-lg shadow-sm">
                    <h3 class="font-bold text-blue-800 mb-3 flex items-center">
                        <span class="text-xl mr-2">ğŸ¤–</span> AI ì¬ë¬´ ìš”ì•½
                    </h3>
                    <p id="aiSummaryText" class="text-gray-800 whitespace-pre-wrap leading-relaxed text-sm md:text-base"></p>
                </div>
                <div id="aiError" class="hidden p-4 bg-red-50 text-red-700 rounded-lg text-sm"></div>
            </div>

            <!-- ê²°ê³¼ ëª©ë¡ -->
            <div id="resultsList" class="space-y-4"></div>
        </div>
    </div>

    <script>
        // --- 1. DOM ìš”ì†Œ ---
        const tickerInput = document.getElementById('tickerInput');
        const searchButton = document.getElementById('searchButton');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('errorMessage');
        const resultsHeaderContainer = document.getElementById('resultsHeaderContainer');
        const resultsHeader = document.getElementById('resultsHeader');
        const resultsList = document.getElementById('resultsList');
        const aiSummaryButton = document.getElementById('aiSummaryButton');
        const aiSummaryArea = document.getElementById('aiSummaryArea');
        const aiLoader = document.getElementById('aiLoader');
        const aiSummaryContent = document.getElementById('aiSummaryContent');
        const aiSummaryText = document.getElementById('aiSummaryText');
        const aiError = document.getElementById('aiError');
        const exchangeRateInfo = document.getElementById('exchangeRateInfo');
        const optionsArea = document.getElementById('optionsArea');
        const autocompleteList = document.getElementById('autocomplete-list');
        
        const summaryCard = document.getElementById('summaryCard');
        const companyName = document.getElementById('companyName');
        const companyTicker = document.getElementById('companyTicker');
        const currentPrice = document.getElementById('currentPrice');
        const priceChange = document.getElementById('priceChange');
        const marketCap = document.getElementById('marketCap');

        // --- 2. API ì„¤ì • ---
        const GEMINI_API_KEY = "";
        const ALPHA_VANTAGE_API_KEYS = [
            "IOLM32O12PSE4LDJ", 
            "Q3H5NC59JKHFVB7X",
            "5I1RLIUUUEEM3LSR"
        ];
        const KEXIM_API_KEY = "ixCOgz4fZCVMO1h0wypjsh6r75on2HlP"; 

        // --- 3. ì „ì—­ ìƒíƒœ ---
        let currentTimeframe = 'annual';
        let currentCurrency = 'usd';
        let usdToKrwRate = 1430; 
        let fetchedData = null; 
        let tickerList = []; 

        // --- 4. ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        window.addEventListener('DOMContentLoaded', async () => {
            await fetchTickerData();
        });

        async function fetchTickerData() {
            try {
                const response = await fetch('https://corsproxy.io/?https://www.sec.gov/files/company_tickers.json');
                const data = await response.json();
                tickerList = Object.values(data);
                console.log(`Loaded ${tickerList.length} companies.`);
            } catch (e) {
                console.warn("Ticker load failed", e);
            }
        }

        tickerInput.addEventListener('input', function() {
            const val = this.value;
            closeAutocomplete();
            if (!val || val.length < 1) return;
            
            const matches = filterCompanies(val);
            if (matches.length > 0) {
                showAutocomplete(matches);
            }
        });

        tickerInput.addEventListener('focus', function() {
            if (this.value.length >= 1) {
                const matches = filterCompanies(this.value);
                if (matches.length > 0) showAutocomplete(matches);
            }
        });

        document.addEventListener('click', function(e) {
            if (e.target !== tickerInput && e.target.parentNode !== autocompleteList) {
                closeAutocomplete();
            }
        });

        function filterCompanies(query) {
            if (!tickerList.length) return [];
            const q = query.toUpperCase();
            return tickerList.filter(c => 
                c.ticker.startsWith(q) || c.title.toUpperCase().includes(q)
            ).slice(0, 10); 
        }

        function showAutocomplete(matches) {
            autocompleteList.innerHTML = '';
            matches.forEach(match => {
                const li = document.createElement('li');
                li.className = "px-4 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0 flex justify-between items-center";
                li.innerHTML = `
                    <div>
                        <span class="font-bold text-gray-800 w-16 inline-block">${match.ticker}</span>
                        <span class="text-sm text-gray-600 truncate max-w-[200px] sm:max-w-xs inline-block align-bottom">${match.title}</span>
                    </div>
                `;
                li.addEventListener('click', () => {
                    tickerInput.value = match.ticker;
                    closeAutocomplete();
                    searchFilings(); 
                });
                autocompleteList.appendChild(li);
            });
            autocompleteList.classList.remove('hidden');
        }

        function closeAutocomplete() {
            autocompleteList.innerHTML = '';
            autocompleteList.classList.add('hidden');
        }

        searchButton.addEventListener('click', searchFilings);
        tickerInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                closeAutocomplete();
                searchFilings();
            }
        });

        document.querySelectorAll('input[name="timeframe"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                currentTimeframe = e.target.value;
                if (fetchedData) displayResults(fetchedData.ticker, fetchedData);
            });
        });

        document.querySelectorAll('input[name="currency"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                currentCurrency = e.target.value;
                if (fetchedData) {
                    displayResults(fetchedData.ticker, fetchedData);
                    updateExchangeRateInfo();
                }
            });
        });

        // --- 5. í—¬í¼ í•¨ìˆ˜ ---
        function formatNumber(num, format = 'default') {
            if (num === null || num === undefined || num === 'N/A' || isNaN(num)) return 'N/A';
            num = parseFloat(num); 

            if (format === 'percent') return (num * 100).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + '%';
            if (format === 'ratio') return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + 'x';

            let value = num;
            if (currentCurrency === 'krw' && usdToKrwRate) {
                value = num * usdToKrwRate;
                if (Math.abs(value) >= 1_000_000_000_000) return (value / 1_000_000_000_000).toFixed(2) + 'ì¡°';
                if (Math.abs(value) >= 100_000_000) return (value / 100_000_000).toFixed(2) + 'ì–µ';
                if (Math.abs(value) >= 10_000) return (value / 10_000).toFixed(2) + 'ë§Œ';
                return value.toLocaleString('ko-KR', { maximumFractionDigits: 0 }) + 'ì›';
            } else {
                if (Math.abs(value) >= 1_000_000_000_000) return (value / 1_000_000_000_000).toFixed(2) + 'T';
                if (Math.abs(value) >= 1_000_000_000) return (value / 1_000_000_000).toFixed(2) + 'B';
                if (Math.abs(value) >= 1_000_000) return (value / 1_000_000).toFixed(2) + 'M';
                return value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
        }
        
        function formatPrice(num) {
            if (num === null || num === undefined || isNaN(num)) return '-';
            num = parseFloat(num);
            
            if (currentCurrency === 'krw' && usdToKrwRate) {
                return (num * usdToKrwRate).toLocaleString('ko-KR', { maximumFractionDigits: 0 }) + 'ì›';
            }
            return '$' + num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            try {
                return dateStr.substring(0, 10);
            } catch (e) { return dateStr; }
        }

        function updateExchangeRateInfo(source = 'ê¸°ë³¸ê°’') {
            if (currentCurrency === 'krw' && usdToKrwRate) {
                exchangeRateInfo.textContent = `ì ìš© í™˜ìœ¨: ${usdToKrwRate.toLocaleString()}ì›/USD (${source})`;
                exchangeRateInfo.classList.remove('hidden');
            } else {
                exchangeRateInfo.classList.add('hidden');
            }
        }

        // --- 6. API ê´€ë ¨ í•¨ìˆ˜ ---
        async function fetchWithTimeout(resource, options = {}) {
            const { timeout = 5000 } = options;
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            const response = await fetch(resource, { ...options, signal: controller.signal });
            clearTimeout(id);
            return response;
        }

        async function getExchangeRate() {
            const keximRate = await getKeximRateRecursive();
            if (keximRate) return { rate: keximRate, source: 'í•œêµ­ìˆ˜ì¶œì…ì€í–‰' };

            try {
                const res = await fetchWithTimeout('https://open.er-api.com/v6/latest/USD');
                const json = await res.json();
                if (json?.rates?.KRW) return { rate: json.rates.KRW, source: 'Open Exchange Rates' };
            } catch (e) { console.warn('Fallback API failed', e); }

            return { rate: 1430, source: 'ê¸°ë³¸ê°’ (API ì—°ê²° ì‹¤íŒ¨)' };
        }

        async function getKeximRateRecursive(attempt = 0) {
            if (!KEXIM_API_KEY || attempt > 7) return null;
            const date = new Date();
            date.setDate(date.getDate() - attempt);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const searchDate = `${year}${month}${day}`;
            const url = `https://www.koreaexim.go.kr/site/program/financial/exchangeJSON?authkey=${KEXIM_API_KEY}&searchdate=${searchDate}&data=AP01`;
            const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(url);

            try {
                const res = await fetchWithTimeout(proxyUrl, { timeout: 4000 });
                if (!res.ok) throw new Error('Network error');
                const json = await res.json();
                if (Array.isArray(json)) {
                    const usdData = json.find(item => item.cur_unit === 'USD');
                    if (usdData) return parseFloat(usdData.deal_bas_r.replace(/,/g, ''));
                }
                return await getKeximRateRecursive(attempt + 1);
            } catch (e) { return await getKeximRateRecursive(attempt + 1); }
        }

        async function fetchAlphaVantage(fn, ticker, initialKeyIndex, retries = 5) {
            let currentKeyIndex = initialKeyIndex;
            for (let i = 0; i <= retries; i++) {
                const apiKey = ALPHA_VANTAGE_API_KEYS[currentKeyIndex % ALPHA_VANTAGE_API_KEYS.length];
                const url = `https://www.alphavantage.co/query?function=${fn}&symbol=${ticker}&apikey=${apiKey}`;
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    const data = await res.json();
                    if (data['Information'] || data['Note']) {
                        console.warn(`Limit hit (${fn}). Switching key...`);
                        if (i < retries) {
                            currentKeyIndex++;
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            continue;
                        }
                    }
                    return data;
                } catch (e) {
                    if (i < retries) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        continue;
                    }
                    throw e;
                }
            }
            return { 'Error Message': 'Max retries exceeded' };
        }

        async function searchFilings() {
            const ticker = tickerInput.value.trim().toUpperCase();
            if (!ticker) {
                showError('í‹°ì»¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            showLoader(true);
            showError(null);
            resetUI();
            fetchedData = null;

            try {
                const functions = ['INCOME_STATEMENT', 'BALANCE_SHEET', 'EARNINGS', 'OVERVIEW', 'GLOBAL_QUOTE'];
                const promises = functions.map(async (fn, index) => {
                    await new Promise(resolve => setTimeout(resolve, index * 600));
                    return fetchAlphaVantage(fn, ticker, index);
                });
                const exchangeRatePromise = getExchangeRate();
                const results = await Promise.all([...promises, exchangeRatePromise]);
                const [incomeData, balanceData, earningsData, overviewData, quoteData, exchangeRateData] = results;

                const getError = (d, name) => {
                    if (!d) return `${name} ë°ì´í„° ì—†ìŒ`;
                    if (d['Error Message']) return d['Error Message'];
                    if (d['Information'] || d['Note']) return 'API í•œë„ ì´ˆê³¼';
                    return null;
                };
                const errorMsg = getError(incomeData, 'ìˆ˜ìµ') || getError(balanceData, 'ëŒ€ì°¨ëŒ€ì¡°í‘œ') || 
                                 getError(earningsData, 'EPS') || getError(overviewData, 'ê°œìš”') || getError(quoteData, 'ì£¼ê°€');
                if (errorMsg) throw new Error(errorMsg.includes('limit') || errorMsg === 'API í•œë„ ì´ˆê³¼' ? 'API í•œë„ ì´ˆê³¼' : errorMsg);
                if (!incomeData.annualReports && !incomeData.quarterlyReports) throw new Error('ì¬ë¬´ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

                usdToKrwRate = exchangeRateData.rate;
                document.querySelector('input[name="currency"][value="krw"]').disabled = false;

                fetchedData = { ticker, income: incomeData, balance: balanceData, earnings: earningsData, overview: overviewData, quote: quoteData['Global Quote'] || {}, exchangeSource: exchangeRateData.source };
                optionsArea.classList.remove('hidden'); 
                displayResults(ticker, fetchedData);
                updateExchangeRateInfo(fetchedData.exchangeSource);
            } catch (error) {
                let msg = error.message;
                let showBtn = false;
                if (msg.includes('API í•œë„') || msg.includes('limit')) {
                    msg = 'API í˜¸ì¶œ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.<br>ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                    showBtn = true;
                }
                showError(msg, showBtn);
            } finally {
                showLoader(false);
            }
        }

        // Gemini AI
        async function callGeminiApi(prompt) {
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
             try {
                const response = await fetch(apiUrl, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "AI ì‘ë‹µ ì˜¤ë¥˜";
             } catch(e) { return "AI ìš”ì²­ ì‹¤íŒ¨"; }
        }

        async function generateAiSummary(ticker, keyMetrics, yearHeaders, allData) {
            aiSummaryArea.classList.remove('hidden');
            aiLoader.classList.remove('hidden');
            aiSummaryContent.classList.add('hidden');
            aiError.classList.add('hidden');
            aiSummaryButton.disabled = true;
            try {
                const currentTf = currentTimeframe === 'annual' ? 'ì—°ê°„' : 'ë¶„ê¸°';
                const currentCur = currentCurrency === 'usd' ? 'USD' : 'KRW';
                let dataForPrompt = `${ticker}ì˜ ${currentTf} ì¬ë¬´ ë°ì´í„° (${currentCur} ê¸°ì¤€):\n\n`;
                const yearsToShow = [...yearHeaders.slice(0, 5), ...yearHeaders.slice(-2)];
                const uniqueDates = Array.from(new Set(yearsToShow));
                for (const metric of keyMetrics) {
                    dataForPrompt += `${metric.label}:\n`;
                    for (const dateHeader of uniqueDates) {
                        const rawValue = metric.getValue(dateHeader, allData);
                        const numValue = (rawValue === 'None' || rawValue === 'N/A' || rawValue === undefined) ? 'N/A' : parseFloat(rawValue);
                        if (numValue !== 'N/A') {
                            dataForPrompt += `  - ${dateHeader}: ${formatNumber(numValue, metric.format)}\n`;
                        }
                    }
                }
                const prompt = `ë‹¹ì‹ ì€ ì „ë¬¸ ì¬ë¬´ ë¶„ì„ê°€ì…ë‹ˆë‹¤. ì œê³µëœ ì¬ë¬´ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì´ ê¸°ì—…ì˜ ì¥ê¸°ì ì¸ ì„±ê³¼ì— ëŒ€í•´ í•œêµ­ì–´ë¡œ 3-5ë¬¸ì¥ì˜ ê°„ê²°í•˜ê³  ì¤‘ë¦½ì ì¸ ìš”ì•½ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”.\n\nì œê³µëœ ë°ì´í„°:\n${dataForPrompt}\n\nìš”ì•½:`;
                const summaryText = await callGeminiApi(prompt);
                aiSummaryText.textContent = summaryText;
                aiSummaryContent.classList.remove('hidden');
            } catch (error) {
                aiError.textContent = `AI ìš”ì•½ ìƒì„± ì‹¤íŒ¨: ${error.message}`;
                aiError.classList.remove('hidden');
            } finally {
                aiLoader.classList.add('hidden');
                aiSummaryButton.disabled = false;
            }
        }

        function displayResults(ticker, allData) {
            const { income, balance, earnings, overview, quote } = allData;
            
            resultsHeaderContainer.classList.remove('hidden');
            resultsHeaderContainer.classList.add('flex');
            summaryCard.classList.remove('hidden');
            
            companyName.textContent = overview?.Name || ticker;
            companyTicker.textContent = ticker;
            
            const price = parseFloat(quote['05. price']);
            const shares = parseFloat(overview?.SharesOutstanding);
            const changePercent = parseFloat((quote['10. change percent'] || '0').replace('%', ''));
            
            priceChange.textContent = `${changePercent >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(changePercent).toFixed(2)}%`;
            priceChange.className = `text-xs md:text-sm font-bold px-2 py-0.5 rounded whitespace-nowrap ${changePercent >= 0 ? 'text-red-600 bg-red-50' : changePercent < 0 ? 'text-blue-600 bg-blue-50' : 'text-gray-600 bg-gray-50'}`;
            currentPrice.className = `text-2xl md:text-3xl font-bold tracking-tight ${changePercent >= 0 ? 'text-red-600' : changePercent < 0 ? 'text-blue-600' : 'text-gray-800'}`;
            
            let mktCap = parseFloat(overview?.MarketCapitalization);
            if (price && shares) mktCap = price * shares;
            currentPrice.textContent = formatPrice(price);
            marketCap.textContent = formatNumber(mktCap);

            const reports = currentTimeframe === 'annual' ? income.annualReports : income.quarterlyReports;
            if (!reports || reports.length === 0) {
                showError('í•´ë‹¹ ê¸°ê°„ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const yearHeaders = reports.map(d => d.fiscalDateEnding);
            
            let html = `
                <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
                <table class="w-full min-w-max text-left border-collapse">
                    <thead class="bg-gray-100"><tr>
                        <th class="p-3 border-b border-gray-300 font-semibold text-gray-700 sticky left-0 z-10 bg-gray-100 whitespace-nowrap">ì§€í‘œ</th>`;
            
            yearHeaders.forEach(date => {
                 html += `<th class="p-3 border-b border-gray-300 font-semibold text-gray-700 text-center whitespace-nowrap">
                    <span class="block">${date.substring(0, 4)}</span>
                    <span class="block text-xs font-normal text-gray-500">${formatDate(date)}</span>
                </th>`;
            });
            html += `</tr></thead><tbody>`;

            const keyMetrics = [
                { 
                    label: 'ë§¤ì¶œ', 
                    key: 'totalRevenue', 
                    format: 'default',
                    getValue: (d, all) => (currentTimeframe==='annual'?all.income.annualReports:all.income.quarterlyReports).find(r=>r.fiscalDateEnding===d)?.totalRevenue 
                },
                { 
                    label: 'ì˜ì—…ì´ìµ', 
                    key: 'operatingIncome', 
                    format: 'default',
                    getValue: (d, all) => (currentTimeframe==='annual'?all.income.annualReports:all.income.quarterlyReports).find(r=>r.fiscalDateEnding===d)?.operatingIncome
                },
                { 
                    label: 'ì˜ì—…ì´ìµìœ¨', 
                    computed: (r) => {
                        const rev = parseFloat(r.totalRevenue);
                        const op = parseFloat(r.operatingIncome);
                        return (rev && op) ? op/rev : null; 
                    }, 
                    format: 'percent',
                    getValue: (d, all) => {
                        const r = (currentTimeframe==='annual'?all.income.annualReports:all.income.quarterlyReports).find(rep=>rep.fiscalDateEnding===d);
                        if(!r) return null;
                        return (parseFloat(r.operatingIncome)/parseFloat(r.totalRevenue));
                    }
                },
                { 
                    label: 'ì‹œê°€ì´ì•¡ / ì˜ì—…ì´ìµ', 
                    computed: (r) => {
                        const op = parseFloat(r.operatingIncome);
                        if(!op || op===0) return null;
                        return mktCap / (currentTimeframe === 'quarterly' ? op * 4 : op);
                    }, 
                    format: 'ratio',
                    getValue: (d, all) => {
                        const r = (currentTimeframe==='annual'?all.income.annualReports:all.income.quarterlyReports).find(rep=>rep.fiscalDateEnding===d);
                        if(!r) return null;
                        const op = parseFloat(r.operatingIncome);
                        if(!op || op===0) return null;
                        return mktCap / (currentTimeframe === 'quarterly' ? op * 4 : op);
                    }
                }
            ];

            keyMetrics.forEach(metric => {
                html += `<tr class="even:bg-gray-50 hover:bg-gray-100 transition-colors">
                    <td class="p-3 border-b border-gray-200 font-medium text-gray-800 sticky left-0 z-10 bg-white even:bg-gray-50 hover:bg-gray-100 whitespace-nowrap shadow-[1px_0_0_0_rgba(0,0,0,0.05)]">${metric.label}</td>`;
                
                yearHeaders.forEach((date, colIndex) => {
                    let val = metric.getValue(date, allData);
                    
                    // YoY Calculation Logic
                    let growthHtml = '';
                    // Skip YoY for 'Market Cap / Op Income' (last metric)
                    if (metric.label !== 'ì‹œê°€ì´ì•¡ / ì˜ì—…ì´ìµ') {
                        const prevIndex = colIndex + (currentTimeframe === 'annual' ? 1 : 4);
                        if (prevIndex < yearHeaders.length) {
                            const prevDate = yearHeaders[prevIndex];
                            const prevVal = metric.getValue(prevDate, allData);
                            
                            if (val !== null && prevVal !== null && !isNaN(val) && !isNaN(prevVal) && prevVal != 0) {
                                let change, changeStr, colorClass;
                                
                                if (metric.format === 'percent') {
                                    // Margin: Point difference (%p)
                                    change = (val - prevVal) * 100; 
                                    colorClass = change > 0 ? 'text-red-500' : change < 0 ? 'text-blue-500' : 'text-gray-400';
                                    changeStr = `${change > 0 ? 'â–²' : change < 0 ? 'â–¼' : ''} ${Math.abs(change).toFixed(1)}%p`;
                                } else {
                                    // Revenue/Income: Growth rate (%)
                                    change = ((val - prevVal) / Math.abs(prevVal)) * 100;
                                    colorClass = change > 0 ? 'text-red-500' : change < 0 ? 'text-blue-500' : 'text-gray-400';
                                    changeStr = `${change > 0 ? 'â–²' : change < 0 ? 'â–¼' : ''} ${Math.abs(change).toFixed(1)}%`;
                                }
                                
                                growthHtml = `<span class="block text-xs ${colorClass} mt-1 font-semibold">${changeStr}</span>`;
                            }
                        }
                    }

                    html += `<td class="p-3 border-b border-gray-200 text-right font-mono whitespace-nowrap align-top">
                        <div>${formatNumber(val, metric.format)}</div>
                        ${growthHtml}
                    </td>`;
                });
                html += `</tr>`;
            });

            html += `</tbody></table></div>`;
            resultsList.innerHTML = html;

            aiSummaryButton.classList.remove('hidden');
            aiSummaryButton.onclick = () => generateAiSummary(ticker, keyMetrics, yearHeaders, allData);
        }

        function resetUI() {
            resultsList.innerHTML = '';
            exchangeRateInfo.classList.add('hidden');
            resultsHeaderContainer.classList.add('hidden');
            aiSummaryArea.classList.add('hidden');
            aiSummaryContent.classList.add('hidden');
            aiError.classList.add('hidden');
            aiSummaryButton.classList.add('hidden');
            optionsArea.classList.add('hidden'); 
            summaryCard.classList.add('hidden');
        }

        function resetApp() {
            showError(null);
            loader.classList.add('hidden');
            resetUI();
            tickerInput.value = '';
            tickerInput.focus();
        }

        function showError(message, withButton = false) {
            if (message) {
                errorMessage.innerHTML = `
                    <div class="flex flex-col items-center">
                        <p class="font-medium mb-2">âš ï¸ ì˜¤ë¥˜</p>
                        <p class="text-sm text-gray-700 mb-4">${message}</p>
                        ${withButton ? `<button onclick="resetApp()" class="bg-white text-red-600 border border-red-200 px-6 py-2 rounded-lg text-sm font-bold shadow-sm">ëŒì•„ê°€ê¸°</button>` : ''}
                    </div>
                `;
                errorMessage.classList.remove('hidden');
            } else {
                errorMessage.classList.add('hidden');
            }
        }

        function showLoader(show) {
            if (show) loader.classList.remove('hidden');
            else loader.classList.add('hidden');
        }
    </script>
</body>
</html>